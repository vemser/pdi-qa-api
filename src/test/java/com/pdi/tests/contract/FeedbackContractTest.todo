package com.pdi.tests.contract;

import com.pdi.tests.client.FeedbackClient;
import com.pdi.tests.data.factory.FeedbackDataFactory;
import com.pdi.tests.model.Feedback;
import com.pdi.tests.model.responses.FeedbackResponse;
import io.qameta.allure.Epic;
import io.qameta.allure.Owner;
import io.qameta.allure.Severity;
import io.qameta.allure.SeverityLevel;
import io.restassured.module.jsv.JsonSchemaValidator;
import org.apache.http.HttpStatus;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

// TODO: finalizar implementação (endpoint instável)
// Lógica, mapeamento e endpoints pronto. Apenas finalizar futuramente em review com time de backend.
// DICA: só renomear a extensão do arquivo de ".todo" para ".java"
public class FeedbackContractTest {
    private final FeedbackClient feedbackClient = new FeedbackClient();
    private final FeedbackDataFactory feedbackDataFactory = new FeedbackDataFactory();


    // TODO: implementar futuramente método de listar todos os feedbacks
//    @Test
//    @Epic("Feedback")
//    @Owner("Bruno Moraes Scarpari")
//    @DisplayName("Validar contrato do retorno de todos os feedbacks")
//    public void testValidateAValidCaseOfListAllFeedbacksContract() {
//        feedbackClient.searchAll()
//                .then()
//                    .log().body()
//                    .assertThat().statusCode(HttpStatus.SC_OK)
//                    .body(JsonSchemaValidator.matchesJsonSchemaInClasspath("schemas/feedback/listar_feedback.json"))
//                ;
//    }

    @Test
    @Epic("Feedback")
    @Severity(SeverityLevel.CRITICAL)
    @Owner("Bruno Moraes Scarpari")
    @DisplayName("Validar contrato do retorno ao adicionar um feedback válido")
    public void testValidateAValidCaseOfAddFeedbackContract() {
        var feedback = feedbackDataFactory.feedbackValido();
        var feedbackId = String.valueOf(feedback.getId());

        feedbackClient.addFeedback(feedback)
                .then()
                    .log().body()
                    //.assertThat().statusCode(HttpStatus.SC_CREATED) // OBS.: boas práticas = retornar 201 futuramente
                    .assertThat().statusCode(HttpStatus.SC_OK)
                    .body(JsonSchemaValidator.matchesJsonSchemaInClasspath("schemas/feedback/adicionar_feedback.json"))
                ;

        feedbackClient.deleteFeedback(feedbackId)
                .then()
                    .log().body()
                    .assertThat().statusCode(HttpStatus.SC_OK)
                ;
    }

    @Test
    @Epic("Feedback")
    @Severity(SeverityLevel.CRITICAL)
    @Owner("Bruno Moraes Scarpari")
    @DisplayName("Validar contrato do retorno ao atualizar um feedback válido")
    public void testValidateAValidCaseOfUpdateFeedbackContract() {
        var feedback = feedbackDataFactory.feedbackValido();
        var feedbackId = String.valueOf(feedback.getId());

        feedbackClient.updateFeedback(feedbackId)
                .then()
                    .log().body()
                    .assertThat().statusCode(HttpStatus.SC_OK)
                    .body(JsonSchemaValidator.matchesJsonSchemaInClasspath("schemas/feedback/atualizar_feedback.json"))
                ;

        feedbackClient.deleteFeedback(feedbackId)
                .then()
                    .log().body()
                    .assertThat().statusCode(HttpStatus.SC_OK)
                ;
    }

    @Test
    @Epic("Feedback")
    @Severity(SeverityLevel.CRITICAL)
    @Owner("Bruno Moraes Scarpari")
    @DisplayName("Validar contrato do retorno ao deletar um feedback válido")
    public void testValidateAValidCaseOfDeleteFeedbackContract() {
        Feedback feedback = FeedbackDataFactory.feedbackValido();

        FeedbackResponse feedbackResponse = feedbackClient.addFeedback(feedback)
                .then()
                    .log().body()
                    .assertThat().statusCode(HttpStatus.SC_OK)
                    .extract().as(FeedbackResponse.class)
                ;

        Assertions.assertNotNull(feedbackResponse);

        var feedbackId = String.valueOf(feedbackResponse.feedback.getId());

        feedbackClient.deleteFeedback(feedbackId)
                .then()
                    .log().body()
                    .assertThat().statusCode(HttpStatus.SC_OK)
                    .body(JsonSchemaValidator.matchesJsonSchemaInClasspath("schemas/feedback/deletar_feedback.json"))
                ;
    }
}
